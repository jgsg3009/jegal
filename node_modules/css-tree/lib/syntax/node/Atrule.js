var TYPE = require('../../tokenizer').TYPE;
<<<<<<< HEAD
var rawMode = require('./Raw').mode;

var ATKEYWORD = TYPE.AtKeyword;
=======

var ATRULE = TYPE.Atrule;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
var SEMICOLON = TYPE.Semicolon;
var LEFTCURLYBRACKET = TYPE.LeftCurlyBracket;
var RIGHTCURLYBRACKET = TYPE.RightCurlyBracket;

function consumeRaw(startToken) {
<<<<<<< HEAD
    return this.Raw(startToken, rawMode.leftCurlyBracketOrSemicolon, true);
=======
    return this.Raw(startToken, SEMICOLON, LEFTCURLYBRACKET, false, true);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
}

function isDeclarationBlockAtrule() {
    for (var offset = 1, type; type = this.scanner.lookupType(offset); offset++) {
        if (type === RIGHTCURLYBRACKET) {
            return true;
        }

        if (type === LEFTCURLYBRACKET ||
<<<<<<< HEAD
            type === ATKEYWORD) {
=======
            type === ATRULE) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
            return false;
        }
    }

<<<<<<< HEAD
    return false;
=======
    if (this.tolerant) {
        return false;
    }

    this.scanner.skip(offset);
    this.scanner.eat(RIGHTCURLYBRACKET);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
}

module.exports = {
    name: 'Atrule',
    structure: {
        name: String,
        prelude: ['AtrulePrelude', 'Raw', null],
        block: ['Block', null]
    },
    parse: function() {
        var start = this.scanner.tokenStart;
        var name;
        var nameLowerCase;
        var prelude = null;
        var block = null;

<<<<<<< HEAD
        this.eat(ATKEYWORD);
=======
        this.scanner.eat(ATRULE);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

        name = this.scanner.substrToCursor(start + 1);
        nameLowerCase = name.toLowerCase();
        this.scanner.skipSC();

        // parse prelude
        if (this.scanner.eof === false &&
            this.scanner.tokenType !== LEFTCURLYBRACKET &&
            this.scanner.tokenType !== SEMICOLON) {
            if (this.parseAtrulePrelude) {
<<<<<<< HEAD
                prelude = this.parseWithFallback(this.AtrulePrelude.bind(this, name), consumeRaw);
=======
                var preludeStartToken = this.scanner.currentToken;
                prelude = this.tolerantParse(this.AtrulePrelude.bind(this, name), consumeRaw);

                if (this.tolerant && !this.scanner.eof) {
                    if (prelude.type !== 'Raw' &&
                        this.scanner.tokenType !== LEFTCURLYBRACKET &&
                        this.scanner.tokenType !== SEMICOLON) {
                        prelude = consumeRaw.call(this, preludeStartToken);
                    }
                }
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

                // turn empty AtrulePrelude into null
                if (prelude.type === 'AtrulePrelude' && prelude.children.head === null) {
                    prelude = null;
                }
            } else {
<<<<<<< HEAD
                prelude = consumeRaw.call(this, this.scanner.tokenIndex);
=======
                prelude = consumeRaw.call(this, this.scanner.currentToken);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
            }

            this.scanner.skipSC();
        }

<<<<<<< HEAD
        switch (this.scanner.tokenType) {
            case SEMICOLON:
                this.scanner.next();
                break;

            case LEFTCURLYBRACKET:
                if (this.atrule.hasOwnProperty(nameLowerCase) &&
                    typeof this.atrule[nameLowerCase].block === 'function') {
                    block = this.atrule[nameLowerCase].block.call(this);
                } else {
                    // TODO: should consume block content as Raw?
                    block = this.Block(isDeclarationBlockAtrule.call(this));
                }

                break;
=======
        if (this.atrule.hasOwnProperty(nameLowerCase)) {
            if (typeof this.atrule[nameLowerCase].block === 'function') {
                if (this.scanner.tokenType !== LEFTCURLYBRACKET) {
                    // FIXME: make tolerant
                    this.scanner.error('Curly bracket is expected');
                }

                block = this.atrule[nameLowerCase].block.call(this);
            } else {
                if (!this.tolerant || !this.scanner.eof) {
                    this.scanner.eat(SEMICOLON);
                }
            }
        } else {
            switch (this.scanner.tokenType) {
                case SEMICOLON:
                    this.scanner.next();
                    break;

                case LEFTCURLYBRACKET:
                    // TODO: should consume block content as Raw?
                    block = this.Block(isDeclarationBlockAtrule.call(this));
                    break;

                default:
                    if (!this.tolerant) {
                        this.scanner.error('Semicolon or block is expected');
                    }
            }
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
        }

        return {
            type: 'Atrule',
            loc: this.getLocation(start, this.scanner.tokenStart),
            name: name,
            prelude: prelude,
            block: block
        };
    },
<<<<<<< HEAD
    generate: function(node) {
        this.chunk('@');
        this.chunk(node.name);

        if (node.prelude !== null) {
            this.chunk(' ');
            this.node(node.prelude);
        }

        if (node.block) {
            this.node(node.block);
        } else {
            this.chunk(';');
=======
    generate: function(processChunk, node) {
        processChunk('@');
        processChunk(node.name);

        if (node.prelude !== null) {
            processChunk(' ');
            this.generate(processChunk, node.prelude);
        }

        if (node.block) {
            this.generate(processChunk, node.block);
        } else {
            processChunk(';');
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
        }
    },
    walkContext: 'atrule'
};
