var _ = require('lodash')
var logger = require('./logger').getInstance()

module.exports = {
  init: init,
  getHandlers: getProxyEventHandlers
}

<<<<<<< HEAD
function init(proxy, opts) {
  var handlers = getProxyEventHandlers(opts)

  _.forIn(handlers, function(handler, eventName) {
=======
function init (proxy, opts) {
  var handlers = getProxyEventHandlers(opts)

  _.forIn(handlers, function (handler, eventName) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    proxy.on(eventName, handlers[eventName])
  })

  logger.debug('[HPM] Subscribed to http-proxy events: ', _.keys(handlers))
}

<<<<<<< HEAD
function getProxyEventHandlers(opts) {
  // https://github.com/nodejitsu/node-http-proxy#listening-for-proxy-events
  var proxyEvents = [
    'error',
    'proxyReq',
    'proxyReqWs',
    'proxyRes',
    'open',
    'close'
  ]
  var handlers = {}

  _.forEach(proxyEvents, function(event) {
=======
function getProxyEventHandlers (opts) {
  // https://github.com/nodejitsu/node-http-proxy#listening-for-proxy-events
  var proxyEvents = ['error', 'proxyReq', 'proxyReqWs', 'proxyRes', 'open', 'close']
  var handlers = {}

  _.forEach(proxyEvents, function (event) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    // all handlers for the http-proxy events are prefixed with 'on'.
    // loop through options and try to find these handlers
    // and add them to the handlers object for subscription in init().
    var eventName = _.camelCase('on ' + event)
    var fnHandler = _.get(opts, eventName)

    if (_.isFunction(fnHandler)) {
      handlers[event] = fnHandler
    }
  })

  // add default error handler in absence of error handler
  if (!_.isFunction(handlers.error)) {
    handlers.error = defaultErrorHandler
  }

  // add default close handler in absence of close handler
  if (!_.isFunction(handlers.close)) {
    handlers.close = logClose
  }

  return handlers
}

<<<<<<< HEAD
function defaultErrorHandler(err, req, res) {
  var host = req.headers && req.headers.host
=======
function defaultErrorHandler (err, req, res) {
  var host = (req.headers && req.headers.host)
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  var code = err.code

  if (res.writeHead && !res.headersSent) {
    if (/HPE_INVALID/.test(code)) {
      res.writeHead(502)
    } else {
      switch (code) {
        case 'ECONNRESET':
        case 'ENOTFOUND':
        case 'ECONNREFUSED':
          res.writeHead(504)
          break
<<<<<<< HEAD
        default:
          res.writeHead(500)
=======
        default: res.writeHead(500)
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      }
    }
  }

  res.end('Error occured while trying to proxy to: ' + host + req.url)
}

<<<<<<< HEAD
function logClose(req, socket, head) {
=======
function logClose (req, socket, head) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  // view disconnected websocket connections
  logger.info('[HPM] Client disconnected')
}
