var _ = require('lodash')
var logger = require('./logger.js').getInstance()

module.exports = {
  getTarget: getTarget
}

<<<<<<< HEAD
function getTarget(req, config) {
=======
function getTarget (req, config) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  var newTarget
  var router = config.router

  if (_.isPlainObject(router)) {
    newTarget = getTargetFromProxyTable(req, router)
  } else if (_.isFunction(router)) {
    newTarget = router(req)
  }

  return newTarget
}

<<<<<<< HEAD
function getTargetFromProxyTable(req, table) {
=======
function getTargetFromProxyTable (req, table) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  var result
  var host = req.headers.host
  var path = req.url

  var hostAndPath = host + path

<<<<<<< HEAD
  _.forIn(table, function(value, key) {
    if (containsPath(key)) {
      if (hostAndPath.indexOf(key) > -1) {
        // match 'localhost:3000/api'
=======
  _.forIn(table, function (value, key) {
    if (containsPath(key)) {
      if (hostAndPath.indexOf(key) > -1) { // match 'localhost:3000/api'
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
        result = table[key]
        logger.debug('[HPM] Router table match: "%s"', key)
        return false
      }
    } else {
<<<<<<< HEAD
      if (key === host) {
        // match 'localhost:3000'
=======
      if (key === host) { // match 'localhost:3000'
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
        result = table[key]
        logger.debug('[HPM] Router table match: "%s"', host)
        return false
      }
    }
  })

  return result
}

<<<<<<< HEAD
function containsPath(v) {
=======
function containsPath (v) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  return v.indexOf('/') > -1
}
