var util = require('util')
var _ = require('lodash')

var loggerInstance

var defaultProvider = {
  log: console.log,
  debug: console.log, // use .log(); since console does not have .debug()
  info: console.info,
  warn: console.warn,
  error: console.error
}

// log level 'weight'
var LEVELS = {
  debug: 10,
  info: 20,
  warn: 30,
  error: 50,
  silent: 80
}

module.exports = {
  // singleton
<<<<<<< HEAD
  getInstance: function() {
=======
  getInstance: function () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (!loggerInstance) {
      loggerInstance = new Logger()
    }

    return loggerInstance
  },
  getArrow: getArrow
}

<<<<<<< HEAD
function Logger() {
=======
function Logger () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  var logLevel
  var provider

  var api = {
    log: log,
    debug: debug,
    info: info,
    warn: warn,
    error: error,
<<<<<<< HEAD
    setLevel: function(v) {
=======
    setLevel: function (v) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      if (isValidLevel(v)) {
        logLevel = v
      }
    },
<<<<<<< HEAD
    setProvider: function(fn) {
=======
    setProvider: function (fn) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      if (fn && isValidProvider(fn)) {
        provider = fn(defaultProvider)
      }
    }
  }

  init()

  return api

<<<<<<< HEAD
  function init() {
    api.setLevel('info')
    api.setProvider(function() {
=======
  function init () {
    api.setLevel('info')
    api.setProvider(function () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      return defaultProvider
    })
  }

  // log will log messages, regardless of logLevels
<<<<<<< HEAD
  function log() {
    provider.log(_interpolate.apply(null, arguments))
  }

  function debug() {
=======
  function log () {
    provider.log(_interpolate.apply(null, arguments))
  }

  function debug () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (_showLevel('debug')) {
      provider.debug(_interpolate.apply(null, arguments))
    }
  }

<<<<<<< HEAD
  function info() {
=======
  function info () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (_showLevel('info')) {
      provider.info(_interpolate.apply(null, arguments))
    }
  }

<<<<<<< HEAD
  function warn() {
=======
  function warn () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (_showLevel('warn')) {
      provider.warn(_interpolate.apply(null, arguments))
    }
  }

<<<<<<< HEAD
  function error() {
=======
  function error () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (_showLevel('error')) {
      provider.error(_interpolate.apply(null, arguments))
    }
  }

  /**
   * Decide to log or not to log, based on the log levels 'weight'
   * @param  {String}  showLevel [debug, info, warn, error, silent]
   * @return {Boolean}
   */
<<<<<<< HEAD
  function _showLevel(showLevel) {
    var result = false
    var currentLogLevel = LEVELS[logLevel]

    if (currentLogLevel && currentLogLevel <= LEVELS[showLevel]) {
=======
  function _showLevel (showLevel) {
    var result = false
    var currentLogLevel = LEVELS[logLevel]

    if (currentLogLevel && (currentLogLevel <= LEVELS[showLevel])) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      result = true
    }

    return result
  }

  // make sure logged messages and its data are return interpolated
  // make it possible for additional log data, such date/time or custom prefix.
<<<<<<< HEAD
  function _interpolate() {
=======
  function _interpolate () {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    var fn = _.spread(util.format)
    var result = fn(_.slice(arguments))

    return result
  }

<<<<<<< HEAD
  function isValidProvider(fnProvider) {
=======
  function isValidProvider (fnProvider) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    var result = true

    if (fnProvider && !_.isFunction(fnProvider)) {
      throw new Error('[HPM] Log provider config error. Expecting a function.')
    }

    return result
  }

<<<<<<< HEAD
  function isValidLevel(levelName) {
=======
  function isValidLevel (levelName) {
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    var validLevels = _.keys(LEVELS)
    var isValid = _.includes(validLevels, levelName)

    if (!isValid) {
      throw new Error('[HPM] Log level error. Invalid logLevel.')
    }

    return isValid
  }
}

/**
 * -> normal proxy
 * => router
 * ~> pathRewrite
 * ≈> router + pathRewrite
 *
 * @param  {String} originalPath
 * @param  {String} newPath
 * @param  {String} originalTarget
 * @param  {String} newTarget
 * @return {String}
 */
<<<<<<< HEAD
function getArrow(originalPath, newPath, originalTarget, newTarget) {
  var arrow = ['>']
  var isNewTarget = originalTarget !== newTarget // router
  var isNewPath = originalPath !== newPath // pathRewrite
=======
function getArrow (originalPath, newPath, originalTarget, newTarget) {
  var arrow = ['>']
  var isNewTarget = (originalTarget !== newTarget) // router
  var isNewPath = (originalPath !== newPath) // pathRewrite
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

  if (isNewPath && !isNewTarget) {
    arrow.unshift('~')
  } else if (!isNewPath && isNewTarget) {
    arrow.unshift('=')
  } else if (isNewPath && isNewTarget) {
    arrow.unshift('≈')
  } else {
    arrow.unshift('-')
  }

  return arrow.join('')
}
