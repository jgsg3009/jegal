"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.visitor = void 0;

<<<<<<< HEAD
var _core = require("@babel/core");
=======
function _core() {
  const data = require("@babel/core");

  _core = function _core() {
    return data;
  };

  return data;
}
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

function getTDZStatus(refPath, bindingPath) {
  const executionStatus = bindingPath._guessExecutionStatusRelativeTo(refPath);

  if (executionStatus === "before") {
<<<<<<< HEAD
    return "outside";
  } else if (executionStatus === "after") {
    return "inside";
=======
    return "inside";
  } else if (executionStatus === "after") {
    return "outside";
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
  } else {
    return "maybe";
  }
}

function buildTDZAssert(node, state) {
<<<<<<< HEAD
  return _core.types.callExpression(state.addHelper("temporalRef"), [node, _core.types.stringLiteral(node.name)]);
=======
  return _core().types.callExpression(state.addHelper("temporalRef"), [node, _core().types.stringLiteral(node.name)]);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
}

function isReference(node, scope, state) {
  const declared = state.letReferences[node.name];
  if (!declared) return false;
  return scope.getBindingIdentifier(node.name) === declared;
}

const visitor = {
  ReferencedIdentifier(path, state) {
    if (!state.tdzEnabled) return;
<<<<<<< HEAD
    const {
      node,
      parent,
      scope
    } = path;
=======
    const node = path.node,
          parent = path.parent,
          scope = path.scope;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    if (path.parentPath.isFor({
      left: node
    })) return;
    if (!isReference(node, scope, state)) return;
    const bindingPath = scope.getBinding(node.name).path;
    if (bindingPath.isFunctionDeclaration()) return;
    const status = getTDZStatus(path, bindingPath);
<<<<<<< HEAD
    if (status === "outside") return;
=======
    if (status === "inside") return;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

    if (status === "maybe") {
      const assert = buildTDZAssert(node, state);
      bindingPath.parent._tdzThis = true;
      path.skip();

      if (path.parentPath.isUpdateExpression()) {
        if (parent._ignoreBlockScopingTDZ) return;
<<<<<<< HEAD
        path.parentPath.replaceWith(_core.types.sequenceExpression([assert, parent]));
      } else {
        path.replaceWith(assert);
      }
    } else if (status === "inside") {
      path.replaceWith(_core.template.ast`${state.addHelper("tdz")}("${node.name}")`);
=======
        path.parentPath.replaceWith(_core().types.sequenceExpression([assert, parent]));
      } else {
        path.replaceWith(assert);
      }
    } else if (status === "outside") {
      path.replaceWith(_core().types.throwStatement(_core().types.inherits(_core().types.newExpression(_core().types.identifier("ReferenceError"), [_core().types.stringLiteral(`${node.name} is not defined - temporal dead zone`)]), node)));
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    }
  },

  AssignmentExpression: {
    exit(path, state) {
      if (!state.tdzEnabled) return;
<<<<<<< HEAD
      const {
        node
      } = path;
=======
      const node = path.node;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      if (node._ignoreBlockScopingTDZ) return;
      const nodes = [];
      const ids = path.getBindingIdentifiers();

<<<<<<< HEAD
      for (const name of Object.keys(ids)) {
        const id = ids[name];

        if (isReference(id, path.scope, state)) {
          nodes.push(id);
=======
      for (const name in ids) {
        const id = ids[name];

        if (isReference(id, path.scope, state)) {
          nodes.push(buildTDZAssert(id, state));
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
        }
      }

      if (nodes.length) {
        node._ignoreBlockScopingTDZ = true;
        nodes.push(node);
<<<<<<< HEAD
        path.replaceWithMultiple(nodes.map(n => _core.types.expressionStatement(n)));
=======
        path.replaceWithMultiple(nodes.map(_core().types.expressionStatement));
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
      }
    }

  }
};
exports.visitor = visitor;