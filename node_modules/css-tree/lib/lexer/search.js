<<<<<<< HEAD
var List = require('../common/List');

function getFirstMatchNode(matchNode) {
    if ('node' in matchNode) {
        return matchNode.node;
    }

    return getFirstMatchNode(matchNode.match[0]);
}

function getLastMatchNode(matchNode) {
    if ('node' in matchNode) {
        return matchNode.node;
    }

    return getLastMatchNode(matchNode.match[matchNode.match.length - 1]);
=======
var List = require('../utils/list');

function getFirstMatchNode(matchNode) {
    if (matchNode.type === 'ASTNode') {
        return matchNode.node;
    }

    if (matchNode.match.length !== 0) {
        return getFirstMatchNode(matchNode.match[0]);
    }

    return null;
}

function getLastMatchNode(matchNode) {
    if (matchNode.type === 'ASTNode') {
        return matchNode.node;
    }

    if (matchNode.match.length !== 0) {
        return getLastMatchNode(matchNode.match[matchNode.match.length - 1]);
    }

    return null;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
}

function matchFragments(lexer, ast, match, type, name) {
    function findFragments(matchNode) {
<<<<<<< HEAD
        if (matchNode.syntax !== null &&
            matchNode.syntax.type === type &&
=======
        if (matchNode.type === 'ASTNode') {
            return;
        }

        if (matchNode.syntax.type === type &&
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
            matchNode.syntax.name === name) {
            var start = getFirstMatchNode(matchNode);
            var end = getLastMatchNode(matchNode);

            lexer.syntax.walk(ast, function(node, item, list) {
                if (node === start) {
                    var nodes = new List();
<<<<<<< HEAD
=======
                    var loc = null;
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361

                    do {
                        nodes.appendData(item.data);

                        if (item.data === end) {
                            break;
                        }

                        item = item.next;
                    } while (item !== null);

<<<<<<< HEAD
                    fragments.push({
                        parent: list,
=======
                    if (start.loc !== null && end.loc !== null) {
                        loc = {
                            source: start.loc.source,
                            start: start.loc.start,
                            end: end.loc.end
                        };
                    }

                    fragments.push({
                        parent: list,
                        loc: loc,
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
                        nodes: nodes
                    });
                }
            });
        }

<<<<<<< HEAD
        if (Array.isArray(matchNode.match)) {
            matchNode.match.forEach(findFragments);
        }
=======
        matchNode.match.forEach(findFragments);
>>>>>>> 99ef3b4711c8dcd2f717e43dd012712d1f333361
    }

    var fragments = [];

    if (match.matched !== null) {
        findFragments(match.matched);
    }

    return fragments;
}

module.exports = {
    matchFragments: matchFragments
};
